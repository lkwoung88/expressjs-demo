# 3. add routing
[express.js routing guide](https://expressjs.com/en/guide/routing.html)
### Routing 
* `Routingμ€` `clinet`μ μ”μ²­μ— λ€ν•΄μ„ μ• ν”λ¦¬μΌ€μ΄μ…μ `endpoints(URIs)`κ°€ μ–΄λ–»κ² μ‘λ‹µν•λ”μ§€λ¥Ό κ²°μ •ν•λ” λ©”μ»¤λ‹μ¦μ…λ‹λ‹¤.
* λΌμ°ν…μ€ `Express.js` μ• ν”λ¦¬μΌ€μ΄μ…μ ν•µμ‹¬ κΈ°λ¥ μ¤‘ ν•λ‚λ΅, `URL` κµ¬μ΅°μ™€ `HTTP` λ©”μ„λ“(`GET`, `POST`, `PUT`, `DELETE` λ“±)λ¥Ό κΈ°λ°μΌλ΅ μ”μ²­μ„ μ²λ¦¬ν•©λ‹λ‹¤.

```typescript
const app: Express = express();

app.get('/', (req: Request, res: Response) => {  
    res.send('Hello, TypeScript with Express! π‰');  
});
```
### Routing Methods
* `route method`λ” `HTTP methods`μ—μ„ νμƒλμ—μµλ‹λ‹¤.
* `GET`, `POST`, `PUT`, `DELETE` λ“±μ λ‹¤μ–‘ν• `HTTP` μ”μ²­μ— μƒμ‘ν•λ” λ©”μ„λ“λ¥Ό μ§€μ›ν•©λ‹λ‹¤.
* `app.all()`μ€ λ¨λ“  `HTTP` μ”μ²­μ λ©”μ„λ“λ΅ μ‚¬μ©ν•  μ μμµλ‹λ‹¤. 
```typescript
app.METHOD(path, callback [, callback ...]) 
```
* [app.METHOD](https://expressjs.com/en/5x/api.html#app.METHOD)
### Route Paths
* `Route Path`λ” `URL` κµ¬μ΅°λ¥Ό μ •μν•κ³  ν΄λΌμ΄μ–ΈνΈ μ”μ²­μ„ νΉμ • ν•Έλ“¤λ¬ ν•¨μλ΅ μ—°κ²°ν•λ” μ”μ†μ…λ‹λ‹¤.
* `Route Path`λ” λ¬Έμμ—΄, λ¬Έμμ—΄ ν¨ν„΄, λλ” μ •κ· ν‘ν„μ‹μΌλ΅ μ •μν•  μ μμµλ‹λ‹¤.
* `Expressjs4`, `Expressjs5` μ `path` ν‘ν„λ°©μ‹μ—λ” μ°¨μ΄κ°€ μ΅΄μ¬ν•©λ‹λ‹¤. [migration guide](https://expressjs.com/en/guide/migrating-5.html#path-syntax)
### Route Parameters
* `Route Parameter`λ” `Expresjs`μ—μ„ `URL`μ μΌλ¶€λ¥Ό λ™μ μΌλ΅ μ²λ¦¬ν•  μ μκ² ν•΄μ£Όλ” κΈ°λ¥μ…λ‹λ‹¤.
* `μ½λ΅ (:)`μ„ μ‚¬μ©ν•μ—¬ μ”μ²­μ„ μ²λ¦¬ν•  μ μμµλ‹λ‹¤.
* **νλΌλ―Έν„°λ” ν•­μƒ λ¬Έμμ—΄λ΅ μ „λ‹¬λκΈ° λ•λ¬Έμ—, ν•„μ”ν• κ²½μ° μ μ ν• νƒ€μ…μΌλ΅ λ³€ν™ν•΄μ•Ό ν•©λ‹λ‹¤.**
* μ‚¬μ©μμ μ…λ ¥μ— μ ν¨μ„± κ²€μ‚¬λ¥Ό ν•΄μ•Όν•©λ‹λ‹¤.
* **URL μΈμ½”λ”©λ νλΌλ―Έν„°λ” μλ™μΌλ΅ λ””μ½”λ”©λ©λ‹λ‹¤.**
* κ²½λ΅ λ§¤κ°λ³€μμ μ΄λ¦„μ€ 'λ‹¨μ–΄ λ¬Έμ'(\[A-Za-z0-9_])λ΅ κµ¬μ„±λμ–΄μ•Ό ν•©λ‹λ‹¤.
```typescript
router.get('/:page', (req: Request, res: Response) => {  
    const page = req.params.page;  
    res.status(200).send(Array.from(membersMemory.values()));  
});
```
* μ—¬λ¬ νλΌλ―Έν„°λ¥Ό μ‚¬μ©ν•  μ μμµλ‹λ‹¤.
```typescript
app.get('/users/:userId/books/:bookId', (req: Request, res: Response) => {
  res.send(`User: ${req.params.userId}, Book: ${req.params.bookId}`);
});
```
* νλΌλ―Έν„°μ ν•μ‹μ„ μ ν•ν•κΈ° μ„ν•΄ μ •κ·ν‘ν„μ‹μ„ μ‚¬μ©ν•  μ μμµλ‹λ‹¤.
```typescript
app.get('/users/:userId(\\d+)', (req: Request, res: Response) => {
  res.send(`User ID: ${req.params.userId}`);
});
```
* νλΌλ―Έν„°λ¥Ό μ„ νƒμ μΌλ΅ λ§λ“λ ¤λ©΄ `?`λ¥Ό μ‚¬μ©ν•©λ‹λ‹¤.
```typescript
app.get('/users/:userId?', (req: Request, res: Response) => {
  if (req.params.userId) {
    res.send(`User ID: ${req.params.userId}`);
  } else {
    res.send('User list');
  }
});
```
* ν•μ΄ν”(-)κ³Ό μ (.)μ€ λ¬Έμ κ·Έλ€λ΅ ν•΄μ„λλ―€λ΅ κ²½λ΅ λ§¤κ°λ³€μμ™€ ν•¨κ» μ μ©ν• μ©λ„λ΅ μ‚¬μ©ν•  μ μμµλ‹λ‹¤.
```
Route path: /flights/:from-:to
Request URL: http://localhost:3000/flights/LAX-SFO
req.params: { "from": "LAX", "to": "SFO" }

Route path: /plantae/:genus.:species
Request URL: http://localhost:3000/plantae/Prunus.persica
req.params: { "genus": "Prunus", "species": "persica" }
```
### Route Handlers
* Express.jsμ—μ„ μ—¬λ¬ ν•Έλ“¤λ¬κ°€ μμ„ λ•, μ£Όμ… μμ„λ” λ―Έλ“¤μ›¨μ–΄μ™€ λΌμ°νΈ ν•Έλ“¤λ¬κ°€ μ •μλ μμ„λ¥Ό λ”°λ¦…λ‹λ‹¤. μ΄λ” β€λ―Έλ“¤μ›¨μ–΄ μ¤νƒβ€ λλ” β€λ―Έλ“¤μ›¨μ–΄ μ²΄μΈβ€μ΄λΌκ³  λ¶λ¦¬λ” κ°λ…μ μΌλ¶€μ…λ‹λ‹¤.
* app.use() vs νΉμ • λΌμ°νΈ: `app.use()`λ΅ μ •μλ μ „μ—­ λ―Έλ“¤μ›¨μ–΄λ” νΉμ • λΌμ°νΈ ν•Έλ“¤λ¬λ³΄λ‹¤ λ¨Όμ € μ‹¤ν–‰λ©λ‹λ‹¤.
* middle chainμ λ§μ§€λ§‰μ— μ‹¤ν–‰λλ©°, νΉμ • routeμ— λ€ν• μ”μ²­μ— λ€ν•΄μ„ μ‹¤ν–‰λ©λ‹λ‹¤.
* `Route Handler`λ” `Express.js`μ—μ„ νΉμ • `route`μ— λ€ν• μ”μ²­μ„ μ²λ¦¬ν•λ” ν•¨μμ…λ‹λ‹¤.
  * METHOD`λ” `HTTP` λ©”μ„λ“(`GET`, `POST`, `PUT`, `DELETE` λ“±)μ…λ‹λ‹¤.
  * `PATH`λ” λΌμ°νΈ κ²½λ΅μ…λ‹λ‹¤.
  * `req`λ” μ”μ²­ κ°μ²΄μ…λ‹λ‹¤.
  *	`res`λ” μ‘λ‹µ κ°μ²΄μ…λ‹λ‹¤.
  *	`next`λ” λ‹¤μ λ―Έλ“¤μ›¨μ–΄ ν•¨μλ¥Ό νΈμ¶ν•λ” ν•¨μμ…λ‹λ‹¤.
```typescript
app.METHOD(PATH, (req: Request, res: Response, next: NextFunction) => {
  // μ”μ²­ μ²λ¦¬ λ΅μ§
});
```
* ν•λ‚μ `route`μ— μ—¬λ¬ `handler`λ¥Ό μ—°κ²°ν•  μ μμµλ‹λ‹¤.
```typescript
app.get('/example', 
  (req: Request, res: Response, next: NextFunction) => {
    console.log('First handler');
    next();
  },
  (req: Request, res: Response) => {
    res.send('Second handler');
  }
);
```
* μ‘λ‹µ λ©”μ„λ“
	λΌμ°νΈ ν•Έλ“¤λ¬μ—μ„ μ‚¬μ©ν•  μ μλ” μ£Όμ” μ‘λ‹µ λ©”μ„λ“:
	*	`res.send()`: λ‹¤μ–‘ν• μ ν•μ μ‘λ‹µμ„ λ³΄λƒ…λ‹λ‹¤.
	*	`res.json()`: `JSON` μ‘λ‹µμ„ λ³΄λƒ…λ‹λ‹¤.
	*	`res.status()`: `HTTP` μƒνƒ μ½”λ“λ¥Ό μ„¤μ •ν•©λ‹λ‹¤.
	*	`res.redirect()`: λ‹¤λ¥Έ `URL`λ΅ λ¦¬λ‹¤μ΄λ ‰νΈν•©λ‹λ‹¤.
	*	`res.render()`: ν…ν”λ¦Ώμ„ λ λ”λ§ν•©λ‹λ‹¤.
	
* μ—λ¬ μ²λ¦¬λ¥Ό μ„ν• νΉλ³„ν• ν•νƒμ λΌμ°νΈ ν•Έλ“¤λ¬λ„ μμµλ‹λ‹¤.
```typescript
app.use((err: Error, req: Request, res: Response, next: NextFunction) => {
  console.error(err.stack);
  res.status(500).send('Something broke!');
});
```

* `Express.js`μ—μ„ `next` νλΌλ―Έν„°λ” λ―Έλ“¤μ›¨μ–΄ μ‹μ¤ν…μ ν•µμ‹¬ λ¶€λ¶„μΌλ΅, `Express` ν”„λ μ„μ›ν¬μ— μν•΄ μλ™μΌλ΅ μ£Όμ…λ©λ‹λ‹¤. μ΄ κ³Όμ •μ€ λ‹¤μκ³Ό κ°™μ΄ μ‘λ™ν•©λ‹λ‹¤:
	1.	ν•¨μ μ‹κ·Έλ‹μ² μΈμ‹: `Express`λ” λ―Έλ“¤μ›¨μ–΄λ‚ λΌμ°νΈ ν•Έλ“¤λ¬ ν•¨μμ νλΌλ―Έν„° κ°μλ¥Ό ν™•μΈν•©λ‹λ‹¤.
	2.	μλ™ μ£Όμ…: ν•¨μκ°€ 3κ°μ νλΌλ―Έν„°(`req`, `res`, `next`)λ¥Ό κ°€μ§€κ³  μλ‹¤λ©΄, `Express`λ” μλ™μΌλ΅ `next` ν•¨μλ¥Ό μ„Έ λ²μ§Έ μΈμλ΅ μ£Όμ…ν•©λ‹λ‹¤.
	3.	μ—λ¬ μ²λ¦¬ λ―Έλ“¤μ›¨μ–΄: 4κ°μ νλΌλ―Έν„°(`err`, `req`, `res`, `next`)λ¥Ό κ°€μ§„ ν•¨μλ” μ—λ¬ μ²λ¦¬ λ―Έλ“¤μ›¨μ–΄λ΅ μΈμ‹λλ©°, μ²« λ²μ§Έ νλΌλ―Έν„°λ΅ μ—λ¬ κ°μ²΄κ°€ μ£Όμ…λ©λ‹λ‹¤.
```typescript
app.use((req: Request, res: Response, next: NextFunction) => {
  console.log('Always run');
  next();
});

app.get('/user', (req: Request, res: Response, next: NextFunction) => {
  console.log('GET /user - first handler');
  next();
}, (req: Request, res: Response, next: NextFunction) => {
  console.log('GET /user - second handler');
  next();
});

app.get('/user', (req: Request, res: Response) => {
  console.log('GET /user - final handler');
  res.send('User Page');
});

app.use((req: Request, res: Response, next: NextFunction) => {
  console.log('Run if no other route matches');
  next();
});
```
μ΄ μμ‹μ—μ„ `/user`μ— λ€ν• GET μ”μ²­μ μ‹¤ν–‰ μμ„λ” λ‹¤μκ³Ό κ°™μµλ‹λ‹¤.   
	1.	β€Always runβ€ λ―Έλ“¤μ›¨μ–΄   
	2.	β€GET /user - first handlerβ€   
	3.	β€GET /user - second handlerβ€   
	4.	β€GET /user - final handlerβ€   
### app.route()
* `app.route()` λ©”μ„λ“λ” Express.jsμ—μ„ λΌμ°νΈ ν•Έλ“¤λ¬λ¥Ό μ²΄μ΄λ‹ λ°©μ‹μΌλ΅ μ •μν•  μ μκ² ν•΄μ£Όλ” κΈ°λ¥μ…λ‹λ‹¤. 
* μ΄ λ©”μ„λ“λ¥Ό μ‚¬μ©ν•λ©΄ λ™μΌν• κ²½λ΅μ— λ€ν•΄ μ—¬λ¬ HTTP λ©”μ„λ“μ ν•Έλ“¤λ¬λ¥Ό ν• κ³³μ—μ„ μ •μν•  μ μμ–΄, μ½”λ“μ κ°€λ…μ„±κ³Ό κµ¬μ΅°λ¥Ό κ°μ„ ν•  μ μμµλ‹λ‹¤.
```typescript
const app = express();

app.route('/users')
  .get((req: Request, res: Response) => {
    res.send('Get all users');
  })
  .post((req: Request, res: Response) => {
    res.send('Create a new user');
  })
  .put((req: Request, res: Response) => {
    res.send('Update a user');
  });

```
### express.Router
* Express.Routerλ” Express.js μ• ν”λ¦¬μΌ€μ΄μ…μ—μ„ λ¨λ“μ‹ λ§μ΄ν… κ°€λ¥ν• λΌμ°νΈ ν•Έλ“¤λ¬λ¥Ό μƒμ„±ν•λ” ν΄λμ¤μ…λ‹λ‹¤.
* μ΄λ¥Ό ν†µν•΄ λΌμ°νΈλ¥Ό κ·Έλ£Ήν™”ν•κ³  λ¨λ“ν™”ν•  μ μμ–΄, λ€κ·λ¨ μ• ν”λ¦¬μΌ€μ΄μ…μ κµ¬μ΅°λ¥Ό κ°μ„ ν•κ³  μ½”λ“μ μ¬μ‚¬μ©μ„±μ„ λ†’μΌ μ μμµλ‹λ‹¤.
```typescript
const router = express.Router();
```
* λ―Έλ“¤μ›¨μ–΄ λ° λΌμ°νΈ μ •μλ¥Ό ν•©λ‹λ‹¤.
```typescript
router.use((req: Request, res: Response, next: NextFunction) => {
  console.log('Time:', Date.now());
  next();
});

router.get('/users', (req: Request, res: Response) => {
  res.send('Users list');
});
```
* λ©”μΈ μ•±μ— λ§μ΄νΈ ν•©λ‹λ‹¤.
```typescript
const app = express();
app.use('/api', router);
```
### ν…μ¤νΈ μ½”λ“
* ν…μ¤νΈ λ©μ 
	* κ° λΌμ°νΈκ°€ μμƒλ€λ΅ λ™μ‘ν•λ”μ§€ ν™•μΈν•©λ‹λ‹¤.
	* μ¬λ°”λ¥Έ `HTTP` λ©”μ„λ“μ— μ‘λ‹µν•λ”μ§€ ν…μ¤νΈν•©λ‹λ‹¤.
	* μ‘λ‹µμ ν•μ‹μ΄ μ¬λ°”λ¥Έμ§€ ν™•μΈν•©λ‹λ‹¤.
	* μλ»λ μ”μ²­μ— λ€ν•΄ μ μ ν• μ—λ¬ μ‘λ‹µμ„ λ³΄λ‚΄λ”μ§€ ν…μ¤νΈν•©λ‹λ‹¤.
* supertest
	* `Express` μ• ν”λ¦¬μΌ€μ΄μ…μ `HTTP` μ”μ²­μ„ μ‰½κ² ν…μ¤νΈν•  μ μκ² ν•΄μ£Όλ” λΌμ΄λΈλ¬λ¦¬μ…λ‹λ‹¤.
	* `HTTP` μ”μ²­ μ‹λ®¬λ μ΄μ…: `GET`, `POST`, `PUT`, `DELETE` λ“±μ `HTTP` λ©”μ„λ“λ¥Ό μ‰½κ² μ‹λ®¬λ μ΄μ…ν•  μ μμµλ‹λ‹¤.
	* μ‘λ‹µ κ²€μ¦: μƒνƒ μ½”λ“, ν—¤λ”, λ³Έλ¬Έ λ“± μ‘λ‹µμ λ‹¤μ–‘ν• μΈ΅λ©΄μ„ κ²€μ¦ν•  μ μμµλ‹λ‹¤.
	* Promise μ§€μ›: async/awaitλ¥Ό μ‚¬μ©ν• λΉ„λ™κΈ° ν…μ¤νΈλ¥Ό μ§€μ›ν•©λ‹λ‹¤.
	* μ²΄μ΄λ‹ API: λ©”μ„λ“ μ²΄μ΄λ‹μ„ ν†µν•΄ ν…μ¤νΈ μ½”λ“λ¥Ό κ°„κ²°ν•κ² μ‘μ„±ν•  μ μμµλ‹λ‹¤.
	* Express.js ν†µν•©: Express μ• ν”λ¦¬μΌ€μ΄μ…μ„ μ§μ ‘ ν…μ¤νΈν•  μ μμ–΄ λ³„λ„μ μ„λ²„ μ‹¤ν–‰μ΄ ν•„μ” μ—†μµλ‹λ‹¤.

```typescript
describe('Member Routes', () => {  
  
    describe('GET /api/v1/members', () => {  
        it('get members positive test', (done) => {  
            request(app)  
                .get('/api/v1/members/1')  
                .set('Accept', 'application/json')  
                .expect(200)  
                .expect('Content-Type', /json/)  
                .end((err, res) => {  
                    if (err) {  
                        return done(err);  
                    }  
                    expect(res.body).to.have.property('members');  
                    expect(res.body.members).to.be.instanceof(Array);  
                    done();  
                });  
        });  
  
        it('get members negative test', (done) => {  
            request(app)  
                .get('/api/v1/members/invalid')  
                .set('Accept', 'application/json')  
                .expect(400)  
                .expect('Content-Type', /json/)  
                .end((err, res) => {  
                    if (err) {  
                        return done(err);  
                    }  
                    expect(res.body).to.have.property('message');  
                    expect(res.body.message).to.equal('Invalid page number');  
                    done();  
                });  
        });  
    });
    
});
```
* `describe` λΈ”λ΅μ„ μ‚¬μ©ν•μ—¬ ν…μ¤νΈλ¥Ό κ·Έλ£Ήν™”ν•©λ‹λ‹¤. μ—¬κΈ°μ„λ” β€Member Routes'λΌλ” λ©”μΈ κ·Έλ£Ή μ•„λμ— κ° μ—”λ“ν¬μΈνΈλ³„λ΅ ν•μ„ κ·Έλ£Ήμ„ λ§λ“¤μ—μµλ‹λ‹¤.
* `it` ν•¨μλ¥Ό μ‚¬μ©ν•μ—¬ κ°λ³„ ν…μ¤νΈ μΌ€μ΄μ¤λ¥Ό μ •μν•©λ‹λ‹¤.
* `request(app)`λ¥Ό μ‚¬μ©ν•μ—¬ Express μ• ν”λ¦¬μΌ€μ΄μ…μ— HTTP μ”μ²­μ„ λ³΄λƒ…λ‹λ‹¤.
* `.set('Accept', 'application/json')` λ©”μ„λ“λ” Supertestμ—μ„ HTTP μ”μ²­ ν—¤λ”λ¥Ό μ„¤μ •ν•λ” λ° μ‚¬μ©λ©λ‹λ‹¤. 
* `.get()`, `.post()` λ“±μ λ©”μ„λ“λ΅ HTTP λ©”μ„λ“λ¥Ό μ§€μ •ν•©λ‹λ‹¤.
* `.send()` λ©”μ„λ“λ΅ μ”μ²­ λ³Έλ¬Έμ„ μ„¤μ •ν•©λ‹λ‹¤ (POST μ”μ²­μ κ²½μ°).
* `.expect()`λ΅ μμƒλλ” HTTP μƒνƒ μ½”λ“λ¥Ό μ§€μ •ν•©λ‹λ‹¤.
* `chai`μ `expect` ν•¨μλ¥Ό μ‚¬μ©ν•μ—¬ μ‘λ‹µ λ³Έλ¬Έμ κµ¬μ΅°μ™€ λ‚΄μ©μ„ κ²€μ¦ν•©λ‹λ‹¤.
